# Docker Compose for Pankha Repository
# run:
# docker compose down && docker compose pull && docker compose up -d

services:
  pankha-app:
    container_name: pankha_app
    image: anexgohan/pankha:latest
    logging:
      options:
        max-size: "50m"
        max-file: "2"
        compress: "true"
    ports:
      - "${PANKHA_PORT:-3000}:3000" # Web server (host:container) (change left side only, set to your desired port, or set PANKHA_PORT environment variable)
      - "${WS_PORT:-3002}:3002" # WebSocket server for frontend (host:container) (change left side only, set to your desired port, or set WS_PORT environment variable)
    environment:
      # Timezone: set TIMEZONE in .env (list: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones)
      - TZ=${TIMEZONE:-UTC}
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - pankha-postgres
    restart: unless-stopped

  pankha-postgres:
    container_name: pankha_postgres
    image: postgres:17-alpine
    logging:
      options:
        max-size: "50m"
        max-file: "2"
        compress: "true"
    command:
      - "postgres"
      - "-c"
      - "max_wal_size=${POSTGRES_MAX_WAL_SIZE:-256MB}"
      - "-c"
      - "min_wal_size=${POSTGRES_MIN_WAL_SIZE:-80MB}"
      - "-c"
      - "checkpoint_timeout=${POSTGRES_CHECKPOINT_TIMEOUT:-5min}"
      - "-c"
      - "wal_keep_size=${POSTGRES_WAL_KEEP_SIZE:-128MB}"
      - "-c"
      # PostgreSQL logging: only log warnings and errors (reduces noise)
      # Options: DEBUG5, DEBUG1, INFO, NOTICE, WARNING, ERROR, LOG, FATAL, PANIC
      # Default: NOTICE (logs notices, warnings, errors) | Using: WARNING (only warnings and errors)
      - "log_min_messages=WARNING"
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    env_file:
      - .env
    volumes:
      - ./docker-data/backend/database/postgres_data:/var/lib/postgresql/data
      # - ./docker-data/backend/src/database/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    restart: unless-stopped

volumes:
  postgres_data:
